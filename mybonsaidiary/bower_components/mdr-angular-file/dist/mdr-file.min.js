!function(){"use strict";angular.module("mdr.file",[]).directive("mdrFile",["$compile",function(e){var t=function(t,n,i){t.multiple&&n.find("input").attr("multiple","multiple"),t.disabled&&n.find(".mdr-file-dad").addClass("disabled"),e(n.contents())(t)};return{restrict:"E",link:t,controller:"FileCtrl",scope:{url:"@",headers:"=",model:"=",data:"=",size:"=",limit:"=",formats:"=",disabled:"=",multiple:"=",text:"@"},template:'<div class="mdr-file-dad" id="fileId_{{$id}}"><div class="mdr-file-dad-text"><h3><span class="glyphicon glyphicon-cloud-upload"></span>{{text}}</h3></div><input type="file" name="file" onchange="angular.element(this).scope().upload(this)" ng-model="model" ng-disabled="disabled"><div class="row mdr-file-dad-content"><button type="button" class="close" aria-label="Close" ng-click="clearContent()"><span aria-hidden="true">&times;</span></button></div></div>'}}]).controller("FileCtrl",["$scope","$element","$attrs",function(e,t,n){function i(t){e.count={send:0,complete:0,invalid:0,error:0},c(t)&&s(t)&&$.each(t,function(e,t){r(e,t)}),$("#fileId_"+e.$id+" input").replaceWith($("#fileId_"+e.$id+" input").val("").clone(!0))}function r(t,n){function i(){}function r(n){if(n.lengthComputable){var i=n.loaded/n.total*100;$("#fileId_"+e.$id+" .mdr-file-dad-content .preview-"+t+" .progress .progress-bar").css("width",i+"%")}}function l(n){e.$apply(function(){e.count.complete++}),200==c.status?(e.$apply(function(){e.model=JSON.parse(c.response)}),$("#fileId_"+e.$id+" .mdr-file-dad-content .preview-"+t).fadeOut("slow",function(){$(this).remove()})):(e.$apply(function(){e.count.error++}),console.log("Server error "+c.status+", an error occurred while transferring the file."))}function d(e){console.log("An error occurred while transferring the file.")}function s(e){console.log("The transfer has been canceled by the user.")}var c=new XMLHttpRequest;if(c.open("POST",e.url,!0),void 0!==e.headers){var p=e.headers;for(var f in p)c.setRequestHeader(f,p[f])}var u=new FileReader;u.readAsDataURL(n),u.onload=function(i){var r=o(n);if(a(n,t,i.target.result,r.icon,r.messages),r.resp){e.$apply(function(){e.count.send++});var l=new FormData;if(void 0!==e.data)for(var d in e.data)l.append(d,e.data[d]);l.append("file",n),c.send(l)}else e.$apply(function(){e.count.invalid++}),c.abort()},c.addEventListener("loadstart",i,!1),c.addEventListener("progress",r,!1),c.addEventListener("load",l,!1),c.addEventListener("error",d,!1),c.addEventListener("abort",s,!1)}function a(t,n,i,r,a){var o=p(t.size),l=null;l=r?'<span class="glyphicon glyphicon-file"></span>':'<img src="'+i+'">';var d='<div class="col-xs-12 col-sm-6 col-md-4 col-lg-2 preview-'+n+'"><div class="thumbnail">'+l+'<div class="progress"><div class="progress-bar" role="progressbar" aria-valuenow="" aria-valuemin="0" aria-valuemax="100" style="width:0%"></div></div><div class="caption"><p>'+t.name+'</p><p><span class="text-muted">'+o+"</span></p></div></div></div>";$("#fileId_"+e.$id+" .mdr-file-dad-content").append($(d).fadeIn("slow")),void 0!==a&&a.forEach(function(t){$("#fileId_"+e.$id+" .mdr-file-dad-content .preview-"+n+" .thumbnail .caption").append('<p class="text-danger">'+t+"</p>")})}function o(e){var t=[],n=!1,i=l(e),r=d(e);return(i.icon||r.icon)&&(n=!0),i.resp||t.push(i.msg),r.resp||t.push(r.msg),i.resp&&r.resp?{resp:!0,icon:n}:{resp:!1,icon:n,messages:t}}function l(t){var n=!0;if(("image/jpeg"==t.type||"image/png"==t.type||"image/svg+xml"==t.type||"image/gif"==t.type)&&(n=!1),void 0===e.formats)return{resp:!0,icon:n,msg:""};var i=t.name.substring(t.name.lastIndexOf(".")+1).toLowerCase(),r=e.formats;"string"==typeof r&&(r=r.split(","));for(var a=0;a<r.length;a++)if(i==r[a].trim())return{resp:!0,icon:n,msg:""};return{resp:!1,icon:n,msg:"File type "+i+" not allowed"}}function d(t){var n=!1,i=t.size;if(i>512e4&&(n=!0),void 0===e.size)return{resp:!0,icon:n};var r=1e3*e.size*1024;return r>i?{resp:!0,icon:n}:{resp:!1,icon:n,msg:"File exceeds size "+e.size+"MB"}}function s(t){return void 0===e.limit?!0:e.limit<t.length?(alert("Max files upload is "+e.limit),!1):!0}function c(t){return 1==t.length?!0:t.length>1&&e.multiple?!0:(alert("One file for time"),!1)}function p(e){var t=["Bytes","KB","MB","GB","TB"];if(0===e)return"n/a";var n=parseInt(Math.floor(Math.log(e)/Math.log(1024)));return 0===n?e+" "+t[n]:(e/Math.pow(1024,n)).toFixed(1)+" "+t[n]}e.text="Drag or click here",e.count={send:0,complete:0,invalid:0,error:0},t.bind("dragenter",function(e){e.stopPropagation(),e.preventDefault();var t=$(e.target).parent();t.addClass("mdr-file-dad-text-hover")}),t.bind("dragleave",function(e){e.stopPropagation(),e.preventDefault();var t=$(e.target).parent();t.removeClass("mdr-file-dad-text-hover")}),t.bind("dragover",function(e){e.stopPropagation(),e.preventDefault()}),t.bind("drop",function(e){e.stopPropagation(),e.preventDefault();var t=$(e.target).parent();t.removeClass("mdr-file-dad-text-hover");var n=e.originalEvent.dataTransfer.files;i(n)}),e.clearContent=function(){$("#fileId_"+e.$id+" .mdr-file-dad-content div").fadeOut("slow",function(){$(this).remove()}),$("#fileId_"+e.$id+" .mdr-file-dad-content button").fadeOut("slow")},e.upload=function(e){var t=e.files;i(t)},e.$watchCollection("count",function(t,n){t.send==t.complete&&(t.invalid>0||t.error>0)&&$("#fileId_"+e.$id+" .mdr-file-dad-content button").fadeIn("slow")})}])}();